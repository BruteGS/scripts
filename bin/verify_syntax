#!/usr/bin/env ruby

module Syntax
  LICH_EXT  = %w(.rb .lic)
  SYNTAX_OK = "Syntax OK\n"

  def self.pending_files(range:)
    %x{git diff --name-only #{range}}
      .split(" ")
      .select {|file| 
        file.start_with?("scripts/") && LICH_EXT.include?(File.extname(file))
      }
  end

  def self.verify_file(file)
    left_col = file.rjust(30)
    puts "#{left_col}"
    ok = %x{ruby -c #{File.join(Dir.pwd, file)}} 
    exit(1) unless ok.eql?(SYNTAX_OK)
    puts ok.rjust(60)
  end
end

range = ENV.fetch("TRAVIS_COMMIT_RANGE")
puts "verifying commit range %s" % range
Syntax.pending_files(range: range)
      .each {|f| File.exists?(f) && Syntax.verify_file(f) }

